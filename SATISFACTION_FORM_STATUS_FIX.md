# การแก้ไขปุ่มประเมินความพึงพอใจตามสถานะ

## ปัญหาที่พบ
ปุ่ม "ประเมินความพึงพอใจ" แสดงผลในทุกสถานะของเรื่องร้องเรียน แต่ต้องการให้แสดงเฉพาะเมื่อสถานะเป็น "ดำเนินการเสร็จสิ้น"

## การแก้ไขที่ทำ

### 1. แก้ไข CardOfficail.js
- เพิ่ม state `complaintStatus` สำหรับเก็บสถานะของเรื่อง
- เพิ่มฟังก์ชัน `fetchComplaintStatus` เพื่อดึงข้อมูลสถานะจาก API
- เพิ่มการแสดงสถานะใน UI
- เพิ่มเงื่อนไขการแสดงปุ่มประเมินความพึงพอใจ:
  ```javascript
  {complaintStatus === "ดำเนินการเสร็จสิ้น" && (
    <button className="btn btn-info btn-sm text-white">
      <MessageCircleHeart className="w-6 h-6 text-white" /> 
      ประเมินความพึงพอใจ
    </button>
  )}
  ```

### 2. แก้ไข API endpoint (/api/complaints/index.js)
- เพิ่มการรองรับ query parameter `complaintId`
- เพิ่มการดึงข้อมูล complaint ตาม ID:
  ```javascript
  if (req.query.complaintId) {
    query._id = req.query.complaintId;
  }
  ```

### 3. แก้ไข SatisfactionForm.js
- เพิ่ม prop `status` เพื่อรับสถานะของเรื่อง
- เพิ่มการตรวจสอบสถานะก่อนแสดงฟอร์ม:
  ```javascript
  if (status !== "ดำเนินการเสร็จสิ้น") {
    return (
      <div className="text-center p-4 text-gray-500">
        <p>ไม่สามารถประเมินความพึงพอใจได้</p>
        <p className="text-sm">กรุณารอให้การดำเนินการเสร็จสิ้นก่อน</p>
      </div>
    );
  }
  ```

### 4. เพิ่มการ Debug
- เพิ่ม console.log เพื่อติดตามการดึงข้อมูลสถานะ
- แสดงสถานะใน UI เพื่อการตรวจสอบ

## ผลลัพธ์ที่ได้

### ✅ เมื่อสถานะเป็น "ดำเนินการเสร็จสิ้น"
- ปุ่ม "ประเมินความพึงพอใจ" จะแสดงผล
- สามารถคลิกเพื่อเปิดฟอร์มประเมินได้
- ฟอร์มประเมินจะแสดงผลปกติ

### ❌ เมื่อสถานะไม่ใช่ "ดำเนินการเสร็จสิ้น"
- ปุ่ม "ประเมินความพึงพอใจ" จะไม่แสดงผล
- หากพยายามเข้าถึงฟอร์มโดยตรง จะแสดงข้อความแจ้งเตือน

## การทดสอบ

1. **ทดสอบกับสถานะ "ดำเนินการเสร็จสิ้น"**
   - ตรวจสอบว่าปุ่มแสดงผล
   - ตรวจสอบว่าสามารถเปิดฟอร์มได้
   - ตรวจสอบว่าสามารถส่งข้อมูลได้

2. **ทดสอบกับสถานะอื่นๆ**
   - ตรวจสอบว่าปุ่มไม่แสดงผล
   - ตรวจสอบว่าไม่สามารถเข้าถึงฟอร์มได้

3. **ตรวจสอบ Console**
   - ดู console.log เพื่อตรวจสอบการดึงข้อมูลสถานะ
   - ตรวจสอบว่าสถานะถูกส่งมาถูกต้อง

## โครงสร้างข้อมูล

### Complaint Model
```javascript
{
  _id: ObjectId,
  status: String, // "ดำเนินการเสร็จสิ้น", "รอดำเนินการ", etc.
  // ... other fields
}
```

### API Response
```javascript
GET /api/complaints?complaintId={id}
Response: [
  {
    _id: "complaint_id",
    status: "ดำเนินการเสร็จสิ้น",
    // ... other fields
  }
]
```

## หมายเหตุ
- ต้องแน่ใจว่าข้อมูล complaint มี field `status` ที่ถูกต้อง
- สถานะ "ดำเนินการเสร็จสิ้น" ต้องตรงกับที่บันทึกใน database
- การแสดงสถานะใน UI ช่วยในการ debug และตรวจสอบ 